version: 2.1

workflows:
  build-and-test:
    jobs:
      - test:
          filters:
            branches:
              only:
                - develop

jobs:
  # Test
  test:
    docker:
      - image: quay.io/dafiti/k8s-values-updater:develop
    steps:
      - add_ssh_keys:
          fingerprints:
            - "79:4a:52:b0:4f:1a:29:46:5d:a6:f2:77:9d:7b:77:3a"
      - checkout
      - setup_remote_docker
      - run:
          name: Try to commit and push
          command: |
            # Will remove this in the future
            ssh-keyscan -H github.com > ~/.ssh/known_hosts
            # Will update the key pullRequestID on every values file
            /k8s-values-updater bump \
              --dir-path "deploy/live" \
              --email "d.ploy@dafiti.com.br" \
              --tag "$(echo ${CIRCLE_SHA1} | head -c7)" \
              --dir-path "example" \
              --branch "${CIRCLE_BRANCH}"
